var forbes=(function(b,a){b.auth=(function(i){var e=false,z=new Object(),p=null,v=false;var m={active:false,callback:null};var j={login_extralarge_ui:{showTermsLink:"false",height:110,width:360,containerID:"gigya_login_extralarge_div",buttonsStyle:"fullLogo",UIConfig:'<config><body><controls><snbuttons buttonsize="40" /></controls></body></config>',autoDetectUserProviders:"",facepilePosition:"none"},login_existing_ui:{showTermsLink:"false",height:110,width:360,containerID:"gigya-existing-login-ui",buttonsStyle:"fullLogo",UIConfig:'<config><body><controls><snbuttons buttonsize="40" /></controls></body></config>',autoDetectUserProviders:"",facepilePosition:"none",enabledProviders:""},login_large_ui:{showTermsLink:"false",height:100,width:330,containerID:"gigya_login_large_div",buttonsStyle:"fullLogo",UIConfig:'<config><body><controls><snbuttons buttonsize="35" /></controls></body></config>',autoDetectUserProviders:"",facepilePosition:"none"},header_loggedout_ui:{showTermsLink:"false",showWhatsThis:"true",whatsThisText:"Log in to Forbes.com using your accounts at these sites.",height:15,width:90,containerID:"gigyalogindiv",UIConfig:'<config><body><controls><snbuttons buttonsize="15" /></controls></body></config>',autoDetectUserProviders:"",facepilePosition:"none"},header_loggedin_ui:{showTermsLink:"false",showWhatsThis:"true",whatsThisText:"Add a connection to another site so you can login and share with that account too.",height:15,width:90,containerID:"gigyaaddconndiv",UIConfig:'<config><body><controls><snbuttons buttonsize="15" /></controls></body></config>',autoDetectUserProviders:"",facepilePosition:"none"}};function o(){if(e){return false}u();d();n();t();h();p={login:ppi_AjaxURI+"?action=unireg_login_form",register:ppi_AjaxURI+"?action=unireg_login_form&part=register",logout:ppi_AjaxURI+"?action=unireg_logout",forgot_password:ppi_AjaxURI+"?action=unireg_login_form&part=reset-password"};z={logged_in:false};if(i("header div.currentuser").length>0&&i("#gigyaaddconndiv").length>0){var I=i("header div.currentuser").attr("data-user-obj-json");if(typeof I!="undefined"){z=i.parseJSON(I)}else{z={logged_in:true}}gigya.services.socialize.getUserInfo({callback:c})}e=true}function h(){forbes.forms.init({selector:"form.forbes_forms.unireg",on_complete:s})}function n(){i("a.unireg_logout").unbind("click").bind("click",function(I){I.preventDefault();x();return false});i("#header_userinfo").capture_auth_links()}function u(){G();f();A()}function G(){gigya.services.socialize.addEventHandlers({},{onLogin:w,onLogout:F,onConnectionAdded:k,onConnectionRemoved:E})}function f(){if(i("#"+j.header_loggedout_ui.containerID).length>0){gigya.services.socialize.showLoginUI(gigya_conf,j.header_loggedout_ui)}if(i("#"+j.header_loggedin_ui.containerID).length>0){gigya.services.socialize.showAddConnectionsUI(gigya_conf,j.header_loggedin_ui)}if(i.browser.msie&&parseInt(i.browser.version)==7){forbes.util.debug("resizing for IE version:"+i.browser.version);if(i("header div.currentuser").length>0){i(".gigya_chicklet_mask").css({"float":"left"})}else{i(".gigya_chicklet_mask").css({width:"168px"})}}i(".gigya_chicklet_mask").delay(175).show().css({opacity:0}).animate({opacity:1},1000)}function A(){if(i("#"+j.login_large_ui.containerID).length>0){gigya.services.socialize.hideUI();gigya.services.socialize.showLoginUI(gigya_conf,j.login_large_ui)}if(i("#"+j.login_extralarge_ui.containerID).length>0){gigya.services.socialize.hideUI();gigya.services.socialize.showLoginUI(gigya_conf,j.login_extralarge_ui)}}function c(I){forbes.util.debug("gigya_user_check");if(I.errorCode==0){forbes.util.debug(I);if(I.user&&I.user["isSiteUID"]&&I.user["isLoggedIn"]){forbes.util.debug("user is in sync");return}}forbes.util.debug("running unireg_sync");i.post(ppi_AjaxURI,{action:"unireg_sync",error_code:I.errorCode},s,"json")}function y(){return z}function x(I){r({html:C("Logging out...")});i.post(ppi_AjaxURI,{action:"unireg_logout"},function(J){B()},"json")}function w(I){forbes.util.debug("_handle_login");forbes.util.debug(I);forbes.util.debug("logged in via "+I.provider);forbes.util.debug(JSON.stringify(I.user));if(I.provider=="site"){return false}i.post(ppi_AjaxURI,{action:"gigya_login",login_action:"socialLogin",user:JSON.stringify(I.user)},s,"json")}function F(I){forbes.util.debug(I.eventName+" event happened")}function k(I){forbes.util.debug(I.eventName+" event happened");i.post(ppi_AjaxURI,{action:"gigya_connection_added",new_provider:I.provider,user:JSON.stringify(I.user)},s,"json")}function E(I){forbes.util.debug(I.eventName+" event happened:");forbes.util.debug(I)}function g(I){if(typeof I.reason!="undefined"&&I.reason.task=="commenting"){r({html:q(),parse_rules:{h2:"Before you comment..."}});return}if(typeof I.reason!="undefined"&&I.reason.task=="following"){m.active=true;m.callback=I.reason.callback_on_auth;r({html:q(),parse_rules:{h2:"Before you follow..."}});return}m.active=false;r({url:p.login});return}function r(I){if(typeof I.action!="undefined"&&I.action=="cancel"){forbes.modal_window.destroy();return false}var L={};if(typeof I.url!="undefined"){L.url=I.url}if(typeof I.html!="undefined"){L.html=I.html}L.parse_rules=(typeof I.parse_rules!="undefined")?I.parse_rules:undefined;var K=(typeof I.existing_social_connections!="undefined")?I.existing_social_connections:"";var J=(typeof I.done_url!="undefined")?I.done_url:"";L.on_cancel=function(){r({action:"cancel"})};L.on_complete=function(M){if(M.find("div#gigya-existing-login-ui").length>0&&K.length>0){var N=K.split(",").length;forbes.util.debug("displaying existing social connections: "+K);forbes.util.debug("num connections: "+N);j.login_existing_ui.height=(N<4)?55:110;j.login_existing_ui.width=(N<3)?(120*N):360;j.login_existing_ui.enabledProviders=K;gigya.services.socialize.hideUI();gigya.services.socialize.showLoginUI(gigya_conf,j.login_existing_ui)}if(J.length>0&&M.find(".fancy_button.done").length>0){forbes.util.debug("using done_url: "+J);M.find(".fancy_button.done").unbind("click").removeClass("ajaxify").removeClass("refresh_window").attr("href",J)}M.capture_auth_links();M.capture_close_buttons();A();if(m.active){M.find(".fancy_button.continue span.label").text("Continue");M.find(".fancy_button.continue").unbind("click").bind("click",function(){m.callback();return false})}else{if(M.find(".fancy_button.refresh_window").length>0){M.find(".fancy_button.refresh_window").unbind("click").bind("click",function(){i(this).addClass("loadingstate");B();return false})}}forbes.forms.init({selector:"form.forbes_forms.unireg",on_complete:s,on_change:function(){M.capture_auth_links();forbes.modal_window.position({animate:true})}})};forbes.modal_window.load(L)}function s(I){forbes.util.debug("_handle_form_response");forbes.util.debug(I);if(typeof I.success!="undefined"){if(I.success&&I.next){r({html:I.next,done_url:(typeof I.done_url!="undefined")?I.done_url:""});return false}if(typeof I.refresh_window!="undefined"){r({html:C("Logging in...")});setTimeout(function(){B()},250);return false}if(I.success="already_logged"){r({html:D()});return false}}else{if(I.error&&I.error_data&&I.error_data.form){var J={html:I.error_data.form};if(typeof I.error_data.login_providers!="undefined"){J.existing_social_connections=I.error_data.login_providers}r(J);return false}}return true}function d(){i.fn.capture_close_buttons=function(){var I=i(this);I.find("a.fancy_button.close").click(function(J){J.preventDefault();r({action:"cancel"});return false});return I};i.fn.capture_auth_links=function(){var I=i(this);I.find("a.ajaxify").unbind("click").bind("click",l);return I}}function l(J){if(i(".non_modal_wrapper .modal_screen.auth.login, .non_modal_wrapper .modal_screen.auth.signup").length<1){J.preventDefault();var K=i(this),I=K.attr("href"),L=K.attr("title")||null;if(J.which==2||J.metaKey){return true}if(K.hasClass("unireg_login")){r({url:p.login});return false}if(K.hasClass("unireg_register")){r({url:p.register});return false}if(K.hasClass("unireg_forgotpassword")){r({url:p.forgot_password});return false}if(K.hasClass("refresh_window")){r({html:C("Reloading...")});setTimeout(function(){B()},250);return false}if(K.hasClass("fancy_button")&&K.hasClass("done")){r({action:"cancel"});return false}r({url:I});return false}return true}function t(){if(i(".non_modal_wrapper .modal_screen.auth").length<1){return false}forbes.util.scroll_to_obj(i(".modal_screen.auth"),{duration:400,valign:true,highlight:false})}function q(){var I='<div class="modal_screen auth before_action">';I+='<div class="heading">';I+="<h2>Login Required</h2>";I+='<div class="shelf_shadow"></div>';I+="</div>";I+='<div class="main">';I+='<div class="external_auth_options">';I+="<h3>Log in with your social account:</h3>";I+='<div id="gigya_login_extralarge_div"></div>';I+='<div class="clear"></div>';I+="</div>";I+='<hr class="dotted" />';I+='<h3>Or, you can <a class="ajaxify" href="'+p.login+'">log in</a> ';I+='or <a class="ajaxify" href="'+p.register+'">sign up</a> ';I+="using Forbes.";I+="</h3>";I+="</div>";I+="</div>";return I}function D(){var I='<div class="modal_screen auth small">';I+='<div class="heading">';I+="<h2>Youâ€™re already logged in</h2>";I+='<div class="shelf_shadow"></div>';I+="</div>";I+='<div class="main">';I+="<h3>";I+="Perhaps you logged in from a different browser window. We recommend ";I+='<strong><a class="ajaxify refresh_window" href="#">refreshing the page</a></strong> and trying again.';I+="</h3>";I+='<div class="clear"></div>';I+="</div>";I+="</div>";return I}function C(J){var I='<div class="modal_screen auth small">';I+='<div class="heading">';I+="<h2>"+J+"</h2>";I+='<div class="shelf_shadow"></div>';I+="</div>";I+='<div class="main">';I+="<p>";I+=forbes.modal_window.generate_large_loading_spinner_html();I+="</p>";I+='<div class="clear"></div>';I+="</div>";I+="</div>";return I}function B(){if(v){forbes.util.debug("WINDOW RELOAD DISABLED");return}window.location.reload()}function H(){forbes.util.debug("disconnecting from all services ...");gigya.services.socialize.removeConnection()}return{init:o,user:y,login:g,handle_auth_links:l,disconnect_gigya:H}}(a));return b}(forbes||{},jQuery));forbes.bootstrap.register(forbes.auth.init);